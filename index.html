<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¾ã¤æ¯›ã‚¨ã‚¯ã‚¹ãƒ†ã‚µãƒ­ãƒ³ æ—¥å ±ãƒ»ç›®æ¨™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffeef7 0%, #ffe0f0 50%, #ffcce6 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 420px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        
        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        /* åŒæœŸçŠ¶æ…‹è¡¨ç¤º */
        .sync-status {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .sync-online { background-color: #4CAF50; }
        .sync-syncing { background-color: #FF9800; }
        .sync-offline { background-color: #F44336; }
        
        .login-form, .main-content {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="text"], input[type="password"], input[type="date"], input[type="number"], textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ffe0f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 240, 250, 0.5);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #ff69b4;
            background: rgba(255, 240, 250, 0.8);
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.2);
        }
        
        .password-container {
            position: relative;
        }
        
        .password-container input {
            padding-right: 50px;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #ff69b4;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            z-index: 10;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            touch-action: manipulation;
        }
        
        .btn:hover, .btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 20, 147, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.secondary {
            background: linear-gradient(135deg, #dda0dd 0%, #ba55d3 100%);
        }
        
        .btn.logout {
            background: linear-gradient(135deg, #ffa500 0%, #ff6347 100%);
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            background: #f8f9fa;
            color: #666;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .daily-form {
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 240, 250, 0.6);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #ffe0f0;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #ff1493;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .chart-container {
            margin: 20px 0;
            background: rgba(255, 240, 250, 0.3);
            border-radius: 15px;
            padding: 20px;
        }
        
        canvas {
            max-height: 300px !important;
        }
        
        .employee-list {
            margin-bottom: 20px;
        }
        
        .employee-item {
            background: rgba(255, 240, 250, 0.6);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px solid #ffe0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .employee-info h4 {
            color: #ff1493;
            margin-bottom: 5px;
        }
        
        .employee-info p {
            font-size: 14px;
            color: #666;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            margin: 0 5px 0 0;
            width: auto;
        }
        
        .monthly-goals {
            background: rgba(255, 240, 250, 0.6);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #ffe0f0;
        }
        
        .goal-progress {
            margin: 15px 0;
        }
        
        .progress-bar {
            background: #ffe0f0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-3 {
            margin-top: 1rem;
        }
        
        .alert {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* JSONBin.ioè¨­å®šç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .jsonbin-setup {
            text-align: center;
            padding: 20px;
        }
        
        .setup-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ff69b4;
        }
        
        .setup-description {
            background: rgba(255, 240, 250, 0.6);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #ffe0f0;
            text-align: left;
        }
        
        .setup-steps {
            list-style: none;
            padding: 0;
        }
        
        .setup-steps li {
            padding: 8px 0;
            border-bottom: 1px solid #ffe0f0;
        }
        
        .setup-steps li:last-child {
            border-bottom: none;
        }
        
        .api-input-group {
            margin: 20px 0;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="sync-status" id="syncStatus">
                <div class="sync-indicator sync-offline" id="syncIndicator"></div>
                <span id="syncText">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>
            </div>
            <h1>ã¾ã¤æ¯›ã‚¨ã‚¯ã‚¹ãƒ†ã‚µãƒ­ãƒ³</h1>
            <p>æ—¥å ±ãƒ»ç›®æ¨™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2.0</p>
        </div>

        <!-- JSONBin.ioåˆæœŸè¨­å®šç”»é¢ -->
        <div id="jsonbinSetup" class="jsonbin-setup">
            <div class="setup-icon">ğŸ”§</div>
            <h2>åˆæœŸè¨­å®š</h2>
            <p>è¤‡æ•°ç«¯æœ«ã§ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã™ã‚‹ãŸã‚ã€JSONBin.ioã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚</p>
            
            <div class="setup-description">
                <h3>ğŸ“‹ è¨­å®šæ‰‹é †ï¼ˆ1åˆ†ã§å®Œäº†ï¼‰</h3>
                <ol class="setup-steps">
                    <li>1. <a href="https://jsonbin.io" target="_blank">jsonbin.io</a> ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</li>
                    <li>2. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ŒAPI Keysã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                    <li>3. ã€ŒCreate Access Keyã€ã§APIã‚­ãƒ¼ä½œæˆ</li>
                    <li>4. ä¸‹è¨˜ã«APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ä¿å­˜</li>
                </ol>
            </div>
            
            <div class="api-input-group">
                <label for="apiKeyInput">JSONBin.io APIã‚­ãƒ¼:</label>
                <input type="text" id="apiKeyInput" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" style="margin-bottom: 10px;">
                <button class="btn" onclick="saveApiKey()">ä¿å­˜ã—ã¦é–‹å§‹</button>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    â€» ã“ã®ã‚­ãƒ¼ã§å…¨ã¦ã®ç«¯æœ«ã§ãƒ‡ãƒ¼ã‚¿ãŒåŒæœŸã•ã‚Œã¾ã™
                </p>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn secondary" onclick="skipSetup()">å¾Œã§è¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ã¿ï¼‰</button>
            </div>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginScreen" class="hidden">
            <div class="login-form">
                <div class="form-group">
                    <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
                    <input type="text" id="username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›">
                </div>
                <div class="form-group">
                    <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                    <div class="password-container">
                        <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                        <button type="button" class="password-toggle" onclick="togglePassword()">ğŸ‘</button>
                    </div>
                </div>
                <button class="btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div id="loginError" class="alert alert-error hidden">
                    ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚
                </div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="mainContent" class="main-content hidden">
            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('daily')">æ—¥å ±å…¥åŠ›</div>
                <div class="tab" onclick="switchTab('report')">æœˆé–“å ±å‘Š</div>
                <div class="tab" onclick="switchTab('employee')">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</div>
                <div class="tab" onclick="switchTab('settings')">è¨­å®š</div>
            </div>

            <!-- æ—¥å ±å…¥åŠ›ã‚¿ãƒ– -->
            <div id="daily" class="tab-content active">
                <div class="daily-form">
                    <div class="form-group">
                        <label for="reportDate">æ—¥ä»˜:</label>
                        <input type="date" id="reportDate">
                    </div>
                    <div class="form-group">
                        <label for="customerCount">æ¥åº—å®¢æ•°:</label>
                        <input type="number" id="customerCount" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="sales">å£²ä¸Šé‡‘é¡:</label>
                        <input type="number" id="sales" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="newCustomers">æ–°è¦å®¢æ•°:</label>
                        <input type="number" id="newCustomers" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="repeatCustomers">ãƒªãƒ”ãƒ¼ãƒˆå®¢æ•°:</label>
                        <input type="number" id="repeatCustomers" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="memo">ãƒ¡ãƒ¢ãƒ»ç‰¹è¨˜äº‹é …:</label>
                        <textarea id="memo" rows="4" placeholder="ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚„æ°—ã¥ã„ãŸã“ã¨ã‚’è¨˜éŒ²..."></textarea>
                    </div>
                    <button class="btn" onclick="saveDailyReport()">æ—¥å ±ã‚’ä¿å­˜</button>
                </div>

                <!-- ä»Šæ—¥ã®çµ±è¨ˆ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="todayCustomers">0</div>
                        <div class="stat-label">ä»Šæ—¥ã®æ¥åº—æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todaySales">Â¥0</div>
                        <div class="stat-label">ä»Šæ—¥ã®å£²ä¸Š</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthCustomers">0</div>
                        <div class="stat-label">ä»Šæœˆã®æ¥åº—æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthSales">Â¥0</div>
                        <div class="stat-label">ä»Šæœˆã®å£²ä¸Š</div>
                    </div>
                </div>
            </div>

            <!-- æœˆé–“å ±å‘Šã‚¿ãƒ– -->
            <div id="report" class="tab-content">
                <div class="monthly-goals">
                    <h3>ä»Šæœˆã®ç›®æ¨™ã¨å®Ÿç¸¾</h3>
                    <div class="goal-progress">
                        <label>å£²ä¸Šç›®æ¨™: Â¥<span id="salesGoalDisplay">500000</span></label>
                        <div class="progress-bar">
                            <div class="progress-fill" id="salesProgress" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div class="goal-progress">
                        <label>æ¥åº—å®¢æ•°ç›®æ¨™: <span id="customerGoalDisplay">200</span>äºº</label>
                        <div class="progress-bar">
                            <div class="progress-fill" id="customerProgress" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="customerChart"></canvas>
                </div>
            </div>

            <!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã‚¿ãƒ– -->
            <div id="employee" class="tab-content">
                <div class="form-group">
                    <label for="employeeName">ã‚¹ã‚¿ãƒƒãƒ•å:</label>
                    <input type="text" id="employeeName" placeholder="ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›">
                </div>
                <div class="form-group">
                    <label for="employeeRole">å½¹è·:</label>
                    <select id="employeeRole">
                        <option value="stylist">ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ</option>
                        <option value="assistant">ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</option>
                        <option value="manager">åº—é•·</option>
                        <option value="trainee">ç ”ä¿®ç”Ÿ</option>
                    </select>
                </div>
                <button class="btn" onclick="addEmployee()">ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ </button>

                <div class="employee-list" id="employeeList">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>

            <!-- è¨­å®šã‚¿ãƒ– -->
            <div id="settings" class="tab-content">
                <h3>æœˆé–“ç›®æ¨™è¨­å®š</h3>
                <div class="form-group">
                    <label for="salesGoal">å£²ä¸Šç›®æ¨™ (å††):</label>
                    <input type="number" id="salesGoal" placeholder="500000" min="0">
                </div>
                <div class="form-group">
                    <label for="customerGoal">æ¥åº—å®¢æ•°ç›®æ¨™ (äºº):</label>
                    <input type="number" id="customerGoal" placeholder="200" min="0">
                </div>
                <button class="btn" onclick="saveGoals()">ç›®æ¨™ã‚’ä¿å­˜</button>

                <div style="margin-top: 30px;">
                    <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                    <button class="btn secondary" onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn secondary" onclick="importData()">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
                </div>

                <div style="margin-top: 30px;">
                    <h3>åŒæœŸè¨­å®š</h3>
                    <button class="btn secondary" onclick="showApiKeySettings()">APIã‚­ãƒ¼å¤‰æ›´</button>
                    <button class="btn secondary" onclick="forceSyncData()">æ‰‹å‹•åŒæœŸ</button>
                    <div id="syncInfo" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>

                <button class="btn logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </div>

    <script>
        // JSONBin.ioçµ±åˆæ©Ÿèƒ½
        class JSONBinSync {
            constructor() {
                this.apiKey = localStorage.getItem('jsonbin_api_key');
                this.binId = localStorage.getItem('jsonbin_bin_id');
                this.baseUrl = 'https://api.jsonbin.io/v3/b';
                this.isOnline = navigator.onLine;
                this.lastSync = localStorage.getItem('last_sync') || 0;
                
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateSyncStatus('online', 'æ¥ç¶šä¸­');
                    this.autoSync();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateSyncStatus('offline', 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³');
                });
            }

            // APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            hasApiKey() {
                return this.apiKey && this.apiKey.length > 0;
            }

            // åŒæœŸçŠ¶æ…‹ã®è¡¨ç¤ºã‚’æ›´æ–°
            updateSyncStatus(status, text) {
                const indicator = document.getElementById('syncIndicator');
                const textElement = document.getElementById('syncText');
                
                indicator.className = `sync-indicator sync-${status}`;
                textElement.textContent = text;
                
                // åŒæœŸæƒ…å ±ã®æ›´æ–°
                const syncInfo = document.getElementById('syncInfo');
                if (syncInfo) {
                    const lastSyncDate = this.lastSync ? new Date(parseInt(this.lastSync)).toLocaleString() : 'æœªåŒæœŸ';
                    syncInfo.textContent = `æœ€çµ‚åŒæœŸ: ${lastSyncDate}`;
                }
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’JSONBin.ioã«ä¿å­˜
            async saveToCloud(data) {
                if (!this.hasApiKey() || !this.isOnline) {
                    return false;
                }

                try {
                    this.updateSyncStatus('syncing', 'åŒæœŸä¸­...');
                    
                    const headers = {
                        'Content-Type': 'application/json',
                        'X-Master-Key': this.apiKey
                    };

                    let response;
                    if (this.binId) {
                        // æ—¢å­˜ã®Binã‚’æ›´æ–°
                        response = await fetch(`${this.baseUrl}/${this.binId}`, {
                            method: 'PUT',
                            headers: headers,
                            body: JSON.stringify(data)
                        });
                    } else {
                        // æ–°ã—ã„Binã‚’ä½œæˆ
                        response = await fetch(`${this.baseUrl}`, {
                            method: 'POST',
                            headers: {
                                ...headers,
                                'X-Bin-Name': 'EyelashSalonData'
                            },
                            body: JSON.stringify(data)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            this.binId = result.metadata.id;
                            localStorage.setItem('jsonbin_bin_id', this.binId);
                        }
                    }

                    if (response.ok) {
                        this.lastSync = Date.now().toString();
                        localStorage.setItem('last_sync', this.lastSync);
                        this.updateSyncStatus('online', 'åŒæœŸæ¸ˆã¿');
                        return true;
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('JSONBin.ioä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateSyncStatus('offline', 'åŒæœŸå¤±æ•—');
                    return false;
                }
            }

            // JSONBin.ioã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            async loadFromCloud() {
                if (!this.hasApiKey() || !this.isOnline || !this.binId) {
                    return null;
                }

                try {
                    this.updateSyncStatus('syncing', 'èª­ã¿è¾¼ã¿ä¸­...');
                    
                    const response = await fetch(`${this.baseUrl}/${this.binId}`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': this.apiKey
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.lastSync = Date.now().toString();
                        localStorage.setItem('last_sync', this.lastSync);
                        this.updateSyncStatus('online', 'åŒæœŸæ¸ˆã¿');
                        return result.record;
                    } else if (response.status === 404) {
                        // BinãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
                        return {};
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('JSONBin.ioèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateSyncStatus('offline', 'èª­ã¿è¾¼ã¿å¤±æ•—');
                    return null;
                }
            }

            // è‡ªå‹•åŒæœŸï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã«å‘¼ã³å‡ºã—ï¼‰
            async autoSync() {
                if (!this.hasApiKey()) return;

                const localData = this.getAllLocalData();
                await this.saveToCloud(localData);
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            getAllLocalData() {
                return {
                    dailyReports: JSON.parse(localStorage.getItem('dailyReports') || '[]'),
                    employees: JSON.parse(localStorage.getItem('employees') || '[]'),
                    goals: JSON.parse(localStorage.getItem('goals') || '{"sales": 500000, "customers": 200}'),
                    settings: JSON.parse(localStorage.getItem('settings') || '{}')
                };
            }

            // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
            async syncFromCloud() {
                const cloudData = await this.loadFromCloud();
                if (cloudData) {
                    // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
                    if (cloudData.dailyReports) {
                        localStorage.setItem('dailyReports', JSON.stringify(cloudData.dailyReports));
                    }
                    if (cloudData.employees) {
                        localStorage.setItem('employees', JSON.stringify(cloudData.employees));
                    }
                    if (cloudData.goals) {
                        localStorage.setItem('goals', JSON.stringify(cloudData.goals));
                    }
                    if (cloudData.settings) {
                        localStorage.setItem('settings', JSON.stringify(cloudData.settings));
                    }
                    
                    // UIã‚’æ›´æ–°
                    updateDashboard();
                    displayEmployees();
                    loadGoals();
                    
                    return true;
                }
                return false;
            }
        }

        // JSONBin.io ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
        const jsonBinSync = new JSONBinSync();

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let currentUser = null;
        let currentTab = 'daily';

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ—¥ä»˜ã®åˆæœŸå€¤è¨­å®š
            document.getElementById('reportDate').valueAsDate = new Date();
            
            // åˆæœŸè¡¨ç¤ºã®æ±ºå®š
            if (jsonBinSync.hasApiKey()) {
                // APIã‚­ãƒ¼ãŒè¨­å®šæ¸ˆã¿ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
                showLoginScreen();
                // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ
                jsonBinSync.syncFromCloud().then(() => {
                    jsonBinSync.updateSyncStatus('online', 'åŒæœŸæ¸ˆã¿');
                });
            } else {
                // APIã‚­ãƒ¼è¨­å®šç”»é¢ã‚’è¡¨ç¤º
                showJsonBinSetup();
            }
        });

        // ç”»é¢è¡¨ç¤ºåˆ¶å¾¡
        function showJsonBinSetup() {
            document.getElementById('jsonbinSetup').classList.remove('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        function showLoginScreen() {
            document.getElementById('jsonbinSetup').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            jsonBinSync.updateSyncStatus(jsonBinSync.isOnline ? 'online' : 'offline', 
                                       jsonBinSync.isOnline ? 'æ¥ç¶šä¸­' : 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³');
        }

        function showMainContent() {
            document.getElementById('jsonbinSetup').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            updateDashboard();
            displayEmployees();
            loadGoals();
        }

        // JSONBin.io APIã‚­ãƒ¼ä¿å­˜
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // APIã‚­ãƒ¼ã‚’ä¿å­˜
            localStorage.setItem('jsonbin_api_key', apiKey);
            jsonBinSync.apiKey = apiKey;
            
            // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•
            showLoginScreen();
            
            // åˆå›ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚’è©¦è¡Œ
            jsonBinSync.syncFromCloud();
        }

        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰
        function skipSetup() {
            showLoginScreen();
            jsonBinSync.updateSyncStatus('offline', 'ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿');
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleButton = document.querySelector('.password-toggle');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.textContent = 'ğŸ™ˆ';
            } else {
                passwordInput.type = 'password';
                toggleButton.textContent = 'ğŸ‘';
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');

            // ç°¡å˜ãªèªè¨¼ï¼ˆå®Ÿéš›ã®é‹ç”¨ã§ã¯é©åˆ‡ãªèªè¨¼ã‚’å®Ÿè£…ï¼‰
            if (username === 'admin' && password === 'eyelash2024') {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                showMainContent();
                errorElement.classList.add('hidden');
            } else {
                errorElement.classList.remove('hidden');
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showLoginScreen();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
            
            // å¿…è¦ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            if (tabName === 'report') {
                updateCharts();
            }
        }

        // æ—¥å ±ä¿å­˜ï¼ˆJSONBin.ioåŒæœŸä»˜ãï¼‰
        async function saveDailyReport() {
            const reportData = {
                date: document.getElementById('reportDate').value,
                customerCount: parseInt(document.getElementById('customerCount').value) || 0,
                sales: parseInt(document.getElementById('sales').value) || 0,
                newCustomers: parseInt(document.getElementById('newCustomers').value) || 0,
                repeatCustomers: parseInt(document.getElementById('repeatCustomers').value) || 0,
                memo: document.getElementById('memo').value
            };

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            let reports = JSON.parse(localStorage.getItem('dailyReports') || '[]');
            const existingIndex = reports.findIndex(r => r.date === reportData.date);
            
            if (existingIndex !== -1) {
                reports[existingIndex] = reportData;
            } else {
                reports.push(reportData);
            }
            
            localStorage.setItem('dailyReports', JSON.stringify(reports));
            
            // JSONBin.ioã«åŒæœŸ
            if (jsonBinSync.hasApiKey()) {
                await jsonBinSync.autoSync();
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('customerCount').value = '';
            document.getElementById('sales').value = '';
            document.getElementById('newCustomers').value = '';
            document.getElementById('repeatCustomers').value = '';
            document.getElementById('memo').value = '';
            
            updateDashboard();
            alert('æ—¥å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        // ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ï¼ˆJSONBin.ioåŒæœŸä»˜ãï¼‰
        async function addEmployee() {
            const name = document.getElementById('employeeName').value;
            const role = document.getElementById('employeeRole').value;
            
            if (!name) {
                alert('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const employee = {
                id: Date.now(),
                name: name,
                role: role,
                addedDate: new Date().toLocaleDateString()
            };

            let employees = JSON.parse(localStorage.getItem('employees') || '[]');
            employees.push(employee);
            localStorage.setItem('employees', JSON.stringify(employees));

            // JSONBin.ioã«åŒæœŸ
            if (jsonBinSync.hasApiKey()) {
                await jsonBinSync.autoSync();
            }

            document.getElementById('employeeName').value = '';
            displayEmployees();
        }

        // ç›®æ¨™ä¿å­˜ï¼ˆJSONBin.ioåŒæœŸä»˜ãï¼‰
        async function saveGoals() {
            const salesGoal = parseInt(document.getElementById('salesGoal').value) || 500000;
            const customerGoal = parseInt(document.getElementById('customerGoal').value) || 200;
            
            const goals = { sales: salesGoal, customers: customerGoal };
            localStorage.setItem('goals', JSON.stringify(goals));

            // JSONBin.ioã«åŒæœŸ
            if (jsonBinSync.hasApiKey()) {
                await jsonBinSync.autoSync();
            }

            alert('ç›®æ¨™ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            updateDashboard();
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateDashboard() {
            const reports = JSON.parse(localStorage.getItem('dailyReports') || '[]');
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            // ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿
            const todayReport = reports.find(r => r.date === today);
            document.getElementById('todayCustomers').textContent = todayReport ? todayReport.customerCount : 0;
            document.getElementById('todaySales').textContent = 'Â¥' + (todayReport ? todayReport.sales.toLocaleString() : 0);

            // ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿
            const monthReports = reports.filter(r => {
                const reportDate = new Date(r.date);
                return reportDate.getMonth() === currentMonth && reportDate.getFullYear() === currentYear;
            });

            const monthCustomers = monthReports.reduce((sum, r) => sum + r.customerCount, 0);
            const monthSales = monthReports.reduce((sum, r) => sum + r.sales, 0);

            document.getElementById('monthCustomers').textContent = monthCustomers;
            document.getElementById('monthSales').textContent = 'Â¥' + monthSales.toLocaleString();

            // ç›®æ¨™é€²æ—ã®æ›´æ–°
            const goals = JSON.parse(localStorage.getItem('goals') || '{"sales": 500000, "customers": 200}');
            const salesProgress = Math.min((monthSales / goals.sales) * 100, 100);
            const customerProgress = Math.min((monthCustomers / goals.customers) * 100, 100);

            document.getElementById('salesProgress').style.width = salesProgress + '%';
            document.getElementById('salesProgress').textContent = Math.round(salesProgress) + '%';
            document.getElementById('customerProgress').style.width = customerProgress + '%';
            document.getElementById('customerProgress').textContent = Math.round(customerProgress) + '%';

            document.getElementById('salesGoalDisplay').textContent = goals.sales.toLocaleString();
            document.getElementById('customerGoalDisplay').textContent = goals.customers;
        }

        // ã‚¹ã‚¿ãƒƒãƒ•è¡¨ç¤º
        function displayEmployees() {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const container = document.getElementById('employeeList');
            
            container.innerHTML = '';
            
            employees.forEach(emp => {
                const div = document.createElement('div');
                div.className = 'employee-item';
                div.innerHTML = `
                    <div class="employee-info">
                        <h4>${emp.name}</h4>
                        <p>${getRoleDisplayName(emp.role)} - è¿½åŠ æ—¥: ${emp.addedDate}</p>
                    </div>
                    <button class="btn btn-small" onclick="removeEmployee(${emp.id})">å‰Šé™¤</button>
                `;
                container.appendChild(div);
            });
        }

        // å½¹è·è¡¨ç¤ºåå¤‰æ›
        function getRoleDisplayName(role) {
            const roleNames = {
                'stylist': 'ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ',
                'assistant': 'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ', 
                'manager': 'åº—é•·',
                'trainee': 'ç ”ä¿®ç”Ÿ'
            };
            return roleNames[role] || role;
        }

        // ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ï¼ˆJSONBin.ioåŒæœŸä»˜ãï¼‰
        async function removeEmployee(id) {
            if (confirm('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                let employees = JSON.parse(localStorage.getItem('employees') || '[]');
                employees = employees.filter(emp => emp.id !== id);
                localStorage.setItem('employees', JSON.stringify(employees));

                // JSONBin.ioã«åŒæœŸ
                if (jsonBinSync.hasApiKey()) {
                    await jsonBinSync.autoSync();
                }

                displayEmployees();
            }
        }

        // ç›®æ¨™èª­ã¿è¾¼ã¿
        function loadGoals() {
            const goals = JSON.parse(localStorage.getItem('goals') || '{"sales": 500000, "customers": 200}');
            document.getElementById('salesGoal').value = goals.sales;
            document.getElementById('customerGoal').value = goals.customers;
        }

        // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
        function updateCharts() {
            const reports = JSON.parse(localStorage.getItem('dailyReports') || '[]');
            
            // éå»30æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
            const last30Days = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const report = reports.find(r => r.date === dateStr);
                
                last30Days.push({
                    date: date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }),
                    sales: report ? report.sales : 0,
                    customers: report ? report.customerCount : 0
                });
            }

            // å£²ä¸Šãƒãƒ£ãƒ¼ãƒˆ
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: last30Days.map(d => d.date),
                    datasets: [{
                        label: 'æ—¥æ¬¡å£²ä¸Š',
                        data: last30Days.map(d => d.sales),
                        borderColor: '#ff69b4',
                        backgroundColor: 'rgba(255, 105, 180, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // æ¥åº—å®¢æ•°ãƒãƒ£ãƒ¼ãƒˆ
            const customerCtx = document.getElementById('customerChart').getContext('2d');
            new Chart(customerCtx, {
                type: 'bar',
                data: {
                    labels: last30Days.map(d => d.date),
                    datasets: [{
                        label: 'æ¥åº—å®¢æ•°',
                        data: last30Days.map(d => d.customers),
                        backgroundColor: 'rgba(255, 105, 180, 0.6)',
                        borderColor: '#ff69b4',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const allData = jsonBinSync.getAllLocalData();
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `eyelash-salon-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importData() {
            document.getElementById('importFile').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                    if (data.dailyReports) localStorage.setItem('dailyReports', JSON.stringify(data.dailyReports));
                    if (data.employees) localStorage.setItem('employees', JSON.stringify(data.employees));
                    if (data.goals) localStorage.setItem('goals', JSON.stringify(data.goals));
                    if (data.settings) localStorage.setItem('settings', JSON.stringify(data.settings));
                    
                    // JSONBin.ioã«åŒæœŸ
                    if (jsonBinSync.hasApiKey()) {
                        await jsonBinSync.autoSync();
                    }
                    
                    // UIã‚’æ›´æ–°
                    updateDashboard();
                    displayEmployees();
                    loadGoals();
                    
                    alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');
                } catch (error) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                }
            };
            reader.readAsText(file);
        }

        // APIã‚­ãƒ¼è¨­å®šè¡¨ç¤º
        function showApiKeySettings() {
            const newApiKey = prompt('æ–°ã—ã„APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', jsonBinSync.apiKey || '');
            if (newApiKey && newApiKey !== jsonBinSync.apiKey) {
                localStorage.setItem('jsonbin_api_key', newApiKey);
                localStorage.removeItem('jsonbin_bin_id'); // æ–°ã—ã„Binã‚’ä½œæˆ
                jsonBinSync.apiKey = newApiKey;
                jsonBinSync.binId = null;
                alert('APIã‚­ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚æ¬¡å›ã®ä¿å­˜æ™‚ã«æ–°ã—ã„BinãŒä½œæˆã•ã‚Œã¾ã™ã€‚');
            }
        }

        // æ‰‹å‹•åŒæœŸ
        async function forceSyncData() {
            if (!jsonBinSync.hasApiKey()) {
                alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            jsonBinSync.updateSyncStatus('syncing', 'åŒæœŸä¸­...');
            
            // ã¾ãšã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const success = await jsonBinSync.syncFromCloud();
            
            if (success) {
                alert('ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸï¼');
            } else {
                alert('åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã¨APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
    </script>
</body>
</html>
