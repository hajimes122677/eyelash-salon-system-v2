<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>まつ毛エクステサロン 日報・目標管理システム</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffeef7 0%, #ffe0f0 50%, #ffcce6 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 420px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        
        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        /* 同期状態表示 */
        .sync-status {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .sync-online { background-color: #4CAF50; }
        .sync-syncing { background-color: #FF9800; }
        .sync-offline { background-color: #F44336; }
        
        .login-form, .main-content {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="text"], input[type="password"], input[type="date"], input[type="number"], textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ffe0f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 240, 250, 0.5);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #ff69b4;
            background: rgba(255, 240, 250, 0.8);
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.2);
        }
        
        .password-container {
            position: relative;
        }
        
        .password-container input {
            padding-right: 50px;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #ff69b4;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            z-index: 10;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            touch-action: manipulation;
        }
        
        .btn:hover, .btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 20, 147, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.secondary {
            background: linear-gradient(135deg, #dda0dd 0%, #ba55d3 100%);
        }
        
        .btn.logout {
            background: linear-gradient(135deg, #ffa500 0%, #ff6347 100%);
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            background: #f8f9fa;
            color: #666;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .daily-form {
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 240, 250, 0.6);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #ffe0f0;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #ff1493;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .chart-container {
            margin: 20px 0;
            background: rgba(255, 240, 250, 0.3);
            border-radius: 15px;
            padding: 20px;
        }
        
        canvas {
            max-height: 300px !important;
        }
        
        .employee-list {
            margin-bottom: 20px;
        }
        
        .employee-item {
            background: rgba(255, 240, 250, 0.6);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px solid #ffe0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .employee-info h4 {
            color: #ff1493;
            margin-bottom: 5px;
        }
        
        .employee-info p {
            font-size: 14px;
            color: #666;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            margin: 0 5px 0 0;
            width: auto;
        }
        
        .monthly-goals {
            background: rgba(255, 240, 250, 0.6);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #ffe0f0;
        }
        
        .goal-progress {
            margin: 15px 0;
        }
        
        .progress-bar {
            background: #ffe0f0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-3 {
            margin-top: 1rem;
        }
        
        .alert {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* JSONBin.io設定画面のスタイル */
        .jsonbin-setup {
            text-align: center;
            padding: 20px;
        }
        
        .setup-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ff69b4;
        }
        
        .setup-description {
            background: rgba(255, 240, 250, 0.6);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #ffe0f0;
            text-align: left;
        }
        
        .setup-steps {
            list-style: none;
            padding: 0;
        }
        
        .setup-steps li {
            padding: 8px 0;
            border-bottom: 1px solid #ffe0f0;
        }
        
        .setup-steps li:last-child {
            border-bottom: none;
        }
        
        .api-input-group {
            margin: 20px 0;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="sync-status" id="syncStatus">
                <div class="sync-indicator sync-offline" id="syncIndicator"></div>
                <span id="syncText">オフライン</span>
            </div>
            <h1>まつ毛エクステサロン</h1>
            <p>日報・目標管理システム v2.0</p>
        </div>

        <!-- JSONBin.io初期設定画面 -->
        <div id="jsonbinSetup" class="jsonbin-setup">
            <div class="setup-icon">🔧</div>
            <h2>初期設定</h2>
            <p>複数端末でデータを同期するため、JSONBin.ioの設定が必要です。</p>
            
            <div class="setup-description">
                <h3>📋 設定手順（1分で完了）</h3>
                <ol class="setup-steps">
                    <li>1. <a href="https://jsonbin.io" target="_blank">jsonbin.io</a> でアカウント作成</li>
                    <li>2. ログイン後「API Keys」をクリック</li>
                    <li>3. 「Create Access Key」でAPIキー作成</li>
                    <li>4. 下記にAPIキーを入力して保存</li>
                </ol>
            </div>
            
            <div class="api-input-group">
                <label for="apiKeyInput">JSONBin.io APIキー:</label>
                <input type="text" id="apiKeyInput" placeholder="APIキーを入力してください" style="margin-bottom: 10px;">
                <button class="btn" onclick="saveApiKey()">保存して開始</button>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    ※ このキーで全ての端末でデータが同期されます
                </p>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn secondary" onclick="skipSetup()">後で設定（ローカル保存のみ）</button>
            </div>
        </div>

        <!-- ログイン画面 -->
        <div id="loginScreen" class="hidden">
            <div class="login-form">
                <div class="form-group">
                    <label for="username">ユーザー名:</label>
                    <input type="text" id="username" placeholder="ユーザー名を入力">
                </div>
                <div class="form-group">
                    <label for="password">パスワード:</label>
                    <div class="password-container">
                        <input type="password" id="password" placeholder="パスワードを入力">
                        <button type="button" class="password-toggle" onclick="togglePassword()">👁</button>
                    </div>
                </div>
                <button class="btn" onclick="login()">ログイン</button>
                <div id="loginError" class="alert alert-error hidden">
                    ユーザー名またはパスワードが正しくありません。
                </div>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div id="mainContent" class="main-content hidden">
            <!-- タブナビゲーション -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('daily')">日報入力</div>
                <div class="tab" onclick="switchTab('report')">月間報告</div>
                <div class="tab" onclick="switchTab('employee')">スタッフ管理</div>
                <div class="tab" onclick="switchTab('settings')">設定</div>
            </div>

            <!-- 日報入力タブ -->
            <div id="daily" class="tab-content active">
                <div class="daily-form">
                    <div class="form-group">
                        <label for="reportDate">日付:</label>
                        <input type="date" id="reportDate">
                    </div>
                    <div class="form-group">
                        <label for="customerCount">来店客数:</label>
                        <input type="number" id="customerCount" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="sales">売上金額:</label>
                        <input type="number" id="sales" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="newCustomers">新規客数:</label>
                        <input type="number" id="newCustomers" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="repeatCustomers">リピート客数:</label>
                        <input type="number" id="repeatCustomers" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="memo">メモ・特記事項:</label>
                        <textarea id="memo" rows="4" placeholder="今日の出来事や気づいたことを記録..."></textarea>
                    </div>
                    <button class="btn" onclick="saveDailyReport()">日報を保存</button>
                </div>

                <!-- 今日の統計 -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="todayCustomers">0</div>
                        <div class="stat-label">今日の来店数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todaySales">¥0</div>
                        <div class="stat-label">今日の売上</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthCustomers">0</div>
                        <div class="stat-label">今月の来店数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthSales">¥0</div>
                        <div class="stat-label">今月の売上</div>
                    </div>
                </div>
            </div>

            <!-- 月間報告タブ -->
            <div id="report" class="tab-content">
                <div class="monthly-goals">
                    <h3>今月の目標と実績</h3>
                    <div class="goal-progress">
                        <label>売上目標: ¥<span id="salesGoalDisplay">500000</span></label>
                        <div class="progress-bar">
                            <div class="progress-fill" id="salesProgress" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div class="goal-progress">
                        <label>来店客数目標: <span id="customerGoalDisplay">200</span>人</label>
                        <div class="progress-bar">
                            <div class="progress-fill" id="customerProgress" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="customerChart"></canvas>
                </div>
            </div>

            <!-- スタッフ管理タブ -->
            <div id="employee" class="tab-content">
                <div class="form-group">
                    <label for="employeeName">スタッフ名:</label>
                    <input type="text" id="employeeName" placeholder="スタッフ名を入力">
                </div>
                <div class="form-group">
                    <label for="employeeRole">役職:</label>
                    <select id="employeeRole">
                        <option value="stylist">スタイリスト</option>
                        <option value="assistant">アシスタント</option>
                        <option value="manager">店長</option>
                        <option value="trainee">研修生</option>
                    </select>
                </div>
                <button class="btn" onclick="addEmployee()">スタッフを追加</button>

                <div class="employee-list" id="employeeList">
                    <!-- 動的に生成 -->
                </div>
            </div>

            <!-- 設定タブ -->
            <div id="settings" class="tab-content">
                <h3>月間目標設定</h3>
                <div class="form-group">
                    <label for="salesGoal">売上目標 (円):</label>
                    <input type="number" id="salesGoal" placeholder="500000" min="0">
                </div>
                <div class="form-group">
                    <label for="customerGoal">来店客数目標 (人):</label>
                    <input type="number" id="customerGoal" placeholder="200" min="0">
                </div>
                <button class="btn" onclick="saveGoals()">目標を保存</button>

                <div style="margin-top: 30px;">
                    <h3>データ管理</h3>
                    <button class="btn secondary" onclick="exportData()">データをエクスポート</button>
                    <button class="btn secondary" onclick="importData()">データをインポート</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
                </div>

                <div style="margin-top: 30px;">
                    <h3>同期設定</h3>
                    <button class="btn secondary" onclick="showApiKeySettings()">APIキー変更</button>
                    <button class="btn secondary" onclick="forceSyncData()">手動同期</button>
                    <div id="syncInfo" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>

                <button class="btn logout" onclick="logout()">ログアウト</button>
            </div>
        </div>
    </div>

    <script>
        // JSONBin.io統合機能
        class JSONBinSync {
            constructor() {
                this.apiKey = localStorage.getItem('jsonbin_api_key');
                this.binId = localStorage.getItem('jsonbin_bin_id');
                this.baseUrl = 'https://api.jsonbin.io/v3/b';
                this.isOnline = navigator.onLine;
                this.lastSync = localStorage.getItem('last_sync') || 0;
                
                // オンライン/オフライン状態の監視
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateSyncStatus('online', '接続中');
                    this.autoSync();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateSyncStatus('offline', 'オフライン');
                });
            }

            // APIキーが設定されているかチェック
            hasApiKey() {
                return this.apiKey && this.apiKey.length > 0;
            }

            // 同期状態の表示を更新
            updateSyncStatus(status, text) {
                const indicator = document.getElementById('syncIndicator');
                const textElement = document.getElementById('syncText');
                
                indicator.className = `sync-indicator sync-${status}`;
                textElement.textContent = text;
                
                // 同期情報の更新
                const syncInfo = document.getElementById('syncInfo');
                if (syncInfo) {
                    const lastSyncDate = this.lastSync ? new Date(parseInt(this.lastSync)).toLocaleString() : '未同期';
                    syncInfo.textContent = `最終同期: ${lastSyncDate}`;
                }
            }

            // データをJSONBin.ioに保存
            async saveToCloud(data) {
                if (!this.hasApiKey() || !this.isOnline) {
                    return false;
                }

                try {
                    this.updateSyncStatus('syncing', '同期中...');
                    
                    const headers = {
                        'Content-Type': 'application/json',
                        'X-Master-Key': this.apiKey
                    };

                    let response;
                    if (this.binId) {
                        // 既存のBinを更新
                        response = await fetch(`${this.baseUrl}/${this.binId}`, {
                            method: 'PUT',
                            headers: headers,
                            body: JSON.stringify(data)
                        });
                    } else {
                        // 新しいBinを作成
                        response = await fetch(`${this.baseUrl}`, {
                            method: 'POST',
                            headers: {
                                ...headers,
                                'X-Bin-Name': 'EyelashSalonData'
                            },
                            body: JSON.stringify(data)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            this.binId = result.metadata.id;
                            localStorage.setItem('jsonbin_bin_id', this.binId);
                        }
                    }

                    if (response.ok) {
                        this.lastSync = Date.now().toString();
                        localStorage.setItem('last_sync', this.lastSync);
                        this.updateSyncStatus('online', '同期済み');
                        return true;
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('JSONBin.io保存エラー:', error);
                    this.updateSyncStatus('offline', '同期失敗');
                    return false;
                }
            }

            // JSONBin.ioからデータを読み込み
            async loadFromCloud() {
                if (!this.hasApiKey() || !this.isOnline || !this.binId) {
                    return null;
                }

                try {
                    this.updateSyncStatus('syncing', '読み込み中...');
                    
                    const response = await fetch(`${this.baseUrl}/${this.binId}`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': this.apiKey
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.lastSync = Date.now().toString();
                        localStorage.setItem('last_sync', this.lastSync);
                        this.updateSyncStatus('online', '同期済み');
                        return result.record;
                    } else if (response.status === 404) {
                        // Binが存在しない場合は空のデータを返す
                        return {};
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('JSONBin.io読み込みエラー:', error);
                    this.updateSyncStatus('offline', '読み込み失敗');
                    return null;
                }
            }

            // 自動同期（データが変更された時に呼び出し）
            async autoSync() {
                if (!this.hasApiKey()) return;

                const localData = this.getAllLocalData();
                await this.saveToCloud(localData);
            }

            // ローカルの全データを取得
            getAllLocalData() {
                return {
                    dailyReports: JSON.parse(localStorage.getItem('dailyReports') || '[]'),
                    employees: JSON.parse(localStorage.getItem('employees') || '[]'),
                    goals: JSON.parse(localStorage.getItem('goals') || '{"sales": 500000, "customers": 200}'),
                    settings: JSON.parse(localStorage.getItem('settings') || '{}')
                };
            }

            // クラウドからデータを同期してローカルに保存
            async syncFromCloud() {
                const cloudData = await this.loadFromCloud();
                if (cloudData) {
                    // クラウドデータをローカルに保存
                    if (cloudData.dailyReports) {
                        localStorage.setItem('dailyReports', JSON.stringify(cloudData.dailyReports));
                    }
                    if (cloudData.employees) {
                        localStorage.setItem('employees', JSON.stringify(cloudData.employees));
                    }
                    if (cloudData.goals) {
                        localStorage.setItem('goals', JSON.stringify(cloudData.goals));
                    }
                    if (cloudData.settings) {
                        localStorage.setItem('settings', JSON.stringify(cloudData.settings));
                    }
                    
                    // UIを更新
                    updateDashboard();
                    displayEmployees();
                    loadGoals();
                    
                    return true;
                }
                return false;
            }
        }

        // JSONBin.io インスタンス作成
        const jsonBinSync = new JSONBinSync();

        // アプリケーション状態
        let currentUser = null;
        let currentTab = 'daily';

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 日付の初期値設定
            document.getElementById('reportDate').valueAsDate = new Date();
            
            // 初期表示の決定
            if (jsonBinSync.hasApiKey()) {
                // APIキーが設定済みの場合はログイン画面を表示
                showLoginScreen();
                // クラウドからデータを同期
                jsonBinSync.syncFromCloud().then(() => {
                    jsonBinSync.updateSyncStatus('online', '同期済み');
                });
            } else {
                // APIキー設定画面を表示
                showJsonBinSetup();
            }
        });

        // 画面表示制御
        function showJsonBinSetup() {
            document.getElementById('jsonbinSetup').classList.remove('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        function showLoginScreen() {
            document.getElementById('jsonbinSetup').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            jsonBinSync.updateSyncStatus(jsonBinSync.isOnline ? 'online' : 'offline', 
                                       jsonBinSync.isOnline ? '接続中' : 'オフライン');
        }

        function showMainContent() {
            document.getElementById('jsonbinSetup').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            updateDashboard();
            displayEmployees();
            loadGoals();
        }

        // JSONBin.io APIキー保存
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                alert('APIキーを入力してください。');
                return;
            }

            // APIキーを保存
            localStorage.setItem('jsonbin_api_key', apiKey);
            jsonBinSync.apiKey = apiKey;
            
            // ログイン画面に移動
            showLoginScreen();
            
            // 初回データ同期を試行
            jsonBinSync.syncFromCloud();
        }

        // セットアップをスキップ（ローカルのみ）
        function skipSetup() {
            showLoginScreen();
            jsonBinSync.updateSyncStatus('offline', 'ローカルのみ');
        }

        // パスワード表示切替
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleButton = document.querySelector('.password-toggle');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                toggleButton.textContent = '👁';
            }
        }

        // ログイン処理
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');

            // 簡単な認証（実際の運用では適切な認証を実装）
            if (username === 'admin' && password === 'eyelash2024') {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                showMainContent();
                errorElement.classList.add('hidden');
            } else {
                errorElement.classList.remove('hidden');
            }
        }

        // ログアウト
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showLoginScreen();
        }

        // タブ切り替え
        function switchTab(tabName) {
            // すべてのタブを非アクティブにする
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 選択されたタブをアクティブにする
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
            
            // 必要に応じてデータを更新
            if (tabName === 'report') {
                updateCharts();
            }
        }

        // 日報保存（JSONBin.io同期付き）
        async function saveDailyReport() {
            const reportData = {
                date: document.getElementById('reportDate').value,
                customerCount: parseInt(document.getElementById('customerCount').value) || 0,
                sales: parseInt(document.getElementById('sales').value) || 0,
                newCustomers: parseInt(document.getElementById('newCustomers').value) || 0,
                repeatCustomers: parseInt(document.getElementById('repeatCustomers').value) || 0,
                memo: document.getElementById('memo').value
            };

            // ローカルストレージに保存
            let reports = JSON.parse(localStorage.getItem('dailyReports') || '[]');
            const existingIndex = reports.findIndex(r => r.date === reportData.date);
            
            if (existingIndex !== -1) {
                reports[existingIndex] = reportData;
            } else {
                reports.push(reportData);
            }
            
            localStorage.setItem('dailyReports', JSON.stringify(reports));
            
            // JSONBin.ioに同期
            if (jsonBinSync.hasApiKey()) {
                await jsonBinSync.autoSync();
            }
            
            // フォームをリセット
            document.getElementById('customerCount').value = '';
            document.getElementById('sales').value = '';
            document.getElementById('newCustomers').value = '';
            document.getElementById('repeatCustomers').value = '';
            document.getElementById('memo').value = '';
            
            updateDashboard();
            alert('日報を保存しました！');
        }

        // スタッフ追加（JSONBin.io同期付き）
        async function addEmployee() {
            const name = document.getElementById('employeeName').value;
            const role = document.getElementById('employeeRole').value;
            
            if (!name) {
                alert('スタッフ名を入力してください。');
                return;
            }

            const employee = {
                id: Date.now(),
                name: name,
                role: role,
                addedDate: new Date().toLocaleDateString()
            };

            let employees = JSON.parse(localStorage.getItem('employees') || '[]');
            employees.push(employee);
            localStorage.setItem('employees', JSON.stringify(employees));

            // JSONBin.ioに同期
            if (jsonBinSync.hasApiKey()) {
                await jsonBinSync.autoSync();
            }

            document.getElementById('employeeName').value = '';
            displayEmployees();
        }

        // 目標保存（JSONBin.io同期付き）
        async function saveGoals() {
            const salesGoal = parseInt(document.getElementById('salesGoal').value) || 500000;
            const customerGoal = parseInt(document.getElementById('customerGoal').value) || 200;
            
            const goals = { sales: salesGoal, customers: customerGoal };
            localStorage.setItem('goals', JSON.stringify(goals));

            // JSONBin.ioに同期
            if (jsonBinSync.hasApiKey()) {
                await jsonBinSync.autoSync();
            }

            alert('目標を保存しました！');
            updateDashboard();
        }

        // ダッシュボード更新
        function updateDashboard() {
            const reports = JSON.parse(localStorage.getItem('dailyReports') || '[]');
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            // 今日のデータ
            const todayReport = reports.find(r => r.date === today);
            document.getElementById('todayCustomers').textContent = todayReport ? todayReport.customerCount : 0;
            document.getElementById('todaySales').textContent = '¥' + (todayReport ? todayReport.sales.toLocaleString() : 0);

            // 今月のデータ
            const monthReports = reports.filter(r => {
                const reportDate = new Date(r.date);
                return reportDate.getMonth() === currentMonth && reportDate.getFullYear() === currentYear;
            });

            const monthCustomers = monthReports.reduce((sum, r) => sum + r.customerCount, 0);
            const monthSales = monthReports.reduce((sum, r) => sum + r.sales, 0);

            document.getElementById('monthCustomers').textContent = monthCustomers;
            document.getElementById('monthSales').textContent = '¥' + monthSales.toLocaleString();

            // 目標進捗の更新
            const goals = JSON.parse(localStorage.getItem('goals') || '{"sales": 500000, "customers": 200}');
            const salesProgress = Math.min((monthSales / goals.sales) * 100, 100);
            const customerProgress = Math.min((monthCustomers / goals.customers) * 100, 100);

            document.getElementById('salesProgress').style.width = salesProgress + '%';
            document.getElementById('salesProgress').textContent = Math.round(salesProgress) + '%';
            document.getElementById('customerProgress').style.width = customerProgress + '%';
            document.getElementById('customerProgress').textContent = Math.round(customerProgress) + '%';

            document.getElementById('salesGoalDisplay').textContent = goals.sales.toLocaleString();
            document.getElementById('customerGoalDisplay').textContent = goals.customers;
        }

        // スタッフ表示
        function displayEmployees() {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const container = document.getElementById('employeeList');
            
            container.innerHTML = '';
            
            employees.forEach(emp => {
                const div = document.createElement('div');
                div.className = 'employee-item';
                div.innerHTML = `
                    <div class="employee-info">
                        <h4>${emp.name}</h4>
                        <p>${getRoleDisplayName(emp.role)} - 追加日: ${emp.addedDate}</p>
                    </div>
                    <button class="btn btn-small" onclick="removeEmployee(${emp.id})">削除</button>
                `;
                container.appendChild(div);
            });
        }

        // 役職表示名変換
        function getRoleDisplayName(role) {
            const roleNames = {
                'stylist': 'スタイリスト',
                'assistant': 'アシスタント', 
                'manager': '店長',
                'trainee': '研修生'
            };
            return roleNames[role] || role;
        }

        // スタッフ削除（JSONBin.io同期付き）
        async function removeEmployee(id) {
            if (confirm('このスタッフを削除しますか？')) {
                let employees = JSON.parse(localStorage.getItem('employees') || '[]');
                employees = employees.filter(emp => emp.id !== id);
                localStorage.setItem('employees', JSON.stringify(employees));

                // JSONBin.ioに同期
                if (jsonBinSync.hasApiKey()) {
                    await jsonBinSync.autoSync();
                }

                displayEmployees();
            }
        }

        // 目標読み込み
        function loadGoals() {
            const goals = JSON.parse(localStorage.getItem('goals') || '{"sales": 500000, "customers": 200}');
            document.getElementById('salesGoal').value = goals.sales;
            document.getElementById('customerGoal').value = goals.customers;
        }

        // チャート更新
        function updateCharts() {
            const reports = JSON.parse(localStorage.getItem('dailyReports') || '[]');
            
            // 過去30日のデータを準備
            const last30Days = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const report = reports.find(r => r.date === dateStr);
                
                last30Days.push({
                    date: date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }),
                    sales: report ? report.sales : 0,
                    customers: report ? report.customerCount : 0
                });
            }

            // 売上チャート
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: last30Days.map(d => d.date),
                    datasets: [{
                        label: '日次売上',
                        data: last30Days.map(d => d.sales),
                        borderColor: '#ff69b4',
                        backgroundColor: 'rgba(255, 105, 180, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // 来店客数チャート
            const customerCtx = document.getElementById('customerChart').getContext('2d');
            new Chart(customerCtx, {
                type: 'bar',
                data: {
                    labels: last30Days.map(d => d.date),
                    datasets: [{
                        label: '来店客数',
                        data: last30Days.map(d => d.customers),
                        backgroundColor: 'rgba(255, 105, 180, 0.6)',
                        borderColor: '#ff69b4',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // データエクスポート
        function exportData() {
            const allData = jsonBinSync.getAllLocalData();
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `eyelash-salon-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // データインポート
        function importData() {
            document.getElementById('importFile').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // データを復元
                    if (data.dailyReports) localStorage.setItem('dailyReports', JSON.stringify(data.dailyReports));
                    if (data.employees) localStorage.setItem('employees', JSON.stringify(data.employees));
                    if (data.goals) localStorage.setItem('goals', JSON.stringify(data.goals));
                    if (data.settings) localStorage.setItem('settings', JSON.stringify(data.settings));
                    
                    // JSONBin.ioに同期
                    if (jsonBinSync.hasApiKey()) {
                        await jsonBinSync.autoSync();
                    }
                    
                    // UIを更新
                    updateDashboard();
                    displayEmployees();
                    loadGoals();
                    
                    alert('データをインポートしました！');
                } catch (error) {
                    alert('ファイルの形式が正しくありません。');
                }
            };
            reader.readAsText(file);
        }

        // APIキー設定表示
        function showApiKeySettings() {
            const newApiKey = prompt('新しいAPIキーを入力してください:', jsonBinSync.apiKey || '');
            if (newApiKey && newApiKey !== jsonBinSync.apiKey) {
                localStorage.setItem('jsonbin_api_key', newApiKey);
                localStorage.removeItem('jsonbin_bin_id'); // 新しいBinを作成
                jsonBinSync.apiKey = newApiKey;
                jsonBinSync.binId = null;
                alert('APIキーを更新しました。次回の保存時に新しいBinが作成されます。');
            }
        }

        // 手動同期
        async function forceSyncData() {
            if (!jsonBinSync.hasApiKey()) {
                alert('APIキーが設定されていません。');
                return;
            }
            
            jsonBinSync.updateSyncStatus('syncing', '同期中...');
            
            // まずクラウドから最新データを取得
            const success = await jsonBinSync.syncFromCloud();
            
            if (success) {
                alert('データの同期が完了しました！');
            } else {
                alert('同期に失敗しました。ネットワーク接続とAPIキーを確認してください。');
            }
        }
    </script>
</body>
</html>
